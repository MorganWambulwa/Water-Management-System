{% extends 'waterapp/base.html' %}

{% block content %}
<div class="container py-5 mt-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold">Dashboard</h2>
        {% if user.is_staff %}
        <a href="{% url 'water_source_create' %}" class="btn btn-primary fw-bold">
            <i class="bi bi-plus-lg me-2"></i> Add New Source
        </a>
        {% endif %}
    </div>

    {% if user.vendor_profile %}
    <div class="card border-0 shadow-sm bg-light mb-5">
        <div class="card-body p-4 d-flex justify-content-between align-items-center">
            <div>
                <h4 class="fw-bold text-primary mb-1">
                    <i class="bi bi-shop me-2"></i> Manage Your Shop
                </h4>
                <p class="text-muted mb-0">Update your details.</p>
            </div>
            <div class="d-flex gap-2">
                <a href="{% url 'vendor_profile_edit' %}" class="btn btn-primary fw-bold rounded-pill px-4">
                    <i class="bi bi-pencil-square me-2"></i> Edit Shop Profile
                </a>
                <a href="{% url 'vendor_report_issue' %}" class="btn btn-warning fw-bold rounded-pill px-4">
                    Request Repair
                </a>
            </div>
        </div>
    </div>
    {% endif %}

    {% if user.is_staff %}
    <div class="row mb-4">
        <div class="col-lg-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title text-muted mb-3">Network Status</h5>
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title text-muted mb-3">Source Types</h5>
                    <canvas id="typeChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0 fw-bold text-danger">High Priority Issues</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th class="ps-4">Source</th>
                                    <th>Problem</th>
                                    <th>Reported</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for issue in open_issues %}
                                <tr>
                                    <td class="ps-4">
                                        {% if issue.water_source %}
                                            <span class="badge bg-info text-dark me-1">Public</span> 
                                            {{ issue.water_source.name }}
                                        {% elif issue.vendor %}
                                            <span class="badge bg-warning text-dark me-1">Refill Station</span> 
                                            {{ issue.vendor.business_name }}
                                        {% else %}
                                            <span class="text-muted italic">Unknown Source</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ issue.description|truncatewords:5 }}</td>
                                    <td>{{ issue.reported_at|date:"M d, H:i" }}</td>
                                    <td>
                                        <form method="post" action="{% url 'issue_toggle_resolve' issue.pk %}">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-sm btn-outline-success rounded-pill px-3">
                                                <i class="bi bi-check-lg"></i> Resolve
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center py-5 text-muted">
                                        <i class="bi bi-check-circle fs-1 text-success d-block mb-2"></i>
                                        No high priority issues!
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0 fw-bold">Management</h5>
                </div>
                <div class="list-group list-group-flush">
                    <a href="{% url 'water_source_list' %}" class="list-group-item list-group-item-action py-3">
                        <i class="bi bi-list-ul me-2 text-primary"></i> View All Sources
                    </a>
                    <a href="/admin/" class="list-group-item list-group-item-action py-3">
                        <i class="bi bi-people me-2 text-primary"></i> Manage Technicians
                    </a>
                    <a href="{% url 'export_issues_csv' %}" class="list-group-item list-group-item-action py-3 text-danger">
                        <i class="bi bi-download me-2"></i> Export Open Issues (CSV)
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if not user.is_staff and not user.vendor_profile %}
    <div class="row">
        <div class="col-12 text-center py-5">
            <h3 class="text-muted">Welcome to WaterConnect</h3>
            <p>Use the map to find water or report an issue.</p>
            <a href="{% url 'water_source_map' %}" class="btn btn-primary btn-lg rounded-pill px-5 mt-3">
                Go to Map
            </a>
        </div>
    </div>
    {% endif %}

</div>

{{ status_counts|json_script:"status-data" }}
{{ source_type_counts|json_script:"type-data" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const statusDataElement = document.getElementById('status-data');
        
        if (statusDataElement) {
            const statusData = JSON.parse(statusDataElement.textContent);
            const typeData = JSON.parse(document.getElementById('type-data').textContent);

            const ctxStatus = document.getElementById('statusChart');
            if(ctxStatus) {
                new Chart(ctxStatus, {
                    type: 'doughnut',
                    data: {
                        labels: statusData.map(d => d.status),
                        datasets: [{
                            data: statusData.map(d => d.count),
                            backgroundColor: ['#198754', '#ffc107', '#dc3545', '#6c757d']
                        }]
                    }
                });
            }

            const ctxType = document.getElementById('typeChart');
            if(ctxType) {
                new Chart(ctxType, {
                    type: 'bar',
                    data: {
                        labels: typeData.map(d => d.source_type),
                        datasets: [{
                            label: 'Count',
                            data: typeData.map(d => d.count),
                            backgroundColor: '#0d6efd'
                        }]
                    }
                });
            }
        }
    });
</script>
{% endblock %}